@model IEnumerable<Proyecto_Diseno_Desarrollo_Grupo5.EF.CATEGORIAS>
@{
    ViewBag.Title = "Categorías";
    Layout = "~/Views/Shared/_LayoutCliente.cshtml";

    var nombre = (Session["NombreUsuario"] ?? "Usuario").ToString();
    var rol = (Session["Rol"] ?? "CLIENTE").ToString();
}

@section styles {
    <link rel="stylesheet" href="~/StaticFiles/css/Index.css" />
}

<div class="lp-nav">
    <div class="lp-nav__inner">
        <div class="lp-brand">
            <img src="~/StaticFiles/img/AlphaStockLogo.png" alt="AlphaStock" />
            <div class="lp-brand__text">
                <b>AlphaStock</b>
                <span>Sistema de Inventarios · Granito & Mármol</span>
            </div>
        </div>

        <nav class="lp-menu">
            <div class="lp-dd">
                <a class="lp-dd__btn" href="javascript:void(0)">Inventario <span class="caret"></span></a>
                <div class="lp-dd__menu">
                    <a class="lp-dd__item" href="#"><b>Materiales</b><span>Catálogo y costos</span></a>
                    <a class="lp-dd__item" href="#"><b>Movimientos</b><span>Entradas / salidas</span></a>
                    <a class="lp-dd__item" href="#"><b>Cortes</b><span>Registro de cortes</span></a>
                </div>
            </div>

            <div class="lp-dd">
                <a class="lp-dd__btn" href="javascript:void(0)">Ventas <span class="caret"></span></a>
                <div class="lp-dd__menu">
                    <a class="lp-dd__item" href="#"><b>Nueva venta</b><span>Factura y detalle</span></a>
                    <a class="lp-dd__item" href="#"><b>Devoluciones</b><span>Gestión y motivo</span></a>
                    <a class="lp-dd__item" href="#"><b>Clientes</b><span>Consulta rápida</span></a>
                </div>
            </div>

            <div class="lp-dd">
                <a class="lp-dd__btn" href="javascript:void(0)">Reportes <span class="caret"></span></a>
                <div class="lp-dd__menu">
                    <a class="lp-dd__item" href="#"><b>Mensual</b><span>Ventas por período</span></a>
                    <a class="lp-dd__item" href="#"><b>Inventario</b><span>Existencias y alertas</span></a>
                    <a class="lp-dd__item" href="#"><b>Cortes</b><span>Resumen de producción</span></a>
                </div>
            </div>

            @if (rol == "ADMINISTRADOR")
            {
                <div class="lp-dd">
                    <a class="lp-dd__btn" href="javascript:void(0)">Administración <span class="caret"></span></a>
                    <div class="lp-dd__menu">
                        <a class="lp-dd__item" href="#"><b>Usuarios</b><span>Roles y estado</span></a>
                        <a class="lp-dd__item" href="#"><b>Parámetros</b><span>Configuración general</span></a>
                        <a class="lp-dd__item" href="#"><b>Bitácora</b><span>Auditoría del sistema</span></a>
                        <a class="lp-dd__item" href="@Url.Action("Index","Categorias")"><b>Categorías</b><span>Crear y administrar categorías</span></a>
                    </div>
                </div>
            }
        </nav>

        <div class="lp-nav__right">
            <span class="lp-pill">Hola, @nombre</span>
            <a class="lp-btn" href="@Url.Action("Logout","Autenticacion")">Salir</a>
        </div>
    </div>
</div>

<section class="lp-hero">
    <div class="lp-wrap">
        <div class="hero">
            <div class="hero__left">
                <span class="hero__kicker">Administración · Categorías</span>
                <h1>Gestión de categorías</h1>
                <p>
                    Desde aquí podés crear, editar y desactivar las categorías que usarán los productos en el sistema.
                </p>

                <div class="hero__cta">
                    @if (rol == "ADMINISTRADOR") { <a class="lp-btn" href="@Url.Action("Create","Categorias")">Nueva categoría</a> }
                    <a class="btn2" href="@Url.Action("Index","Home")">Volver al inicio</a>
                </div>
            </div>

            <div class="hero__right">
                <div class="stats">
                    <div class="stat">
                        <b>Total categorías</b>
                        <span>@(Model != null ? Model.Count() : 0)</span>
                    </div>
                    <div class="stat">
                        <b>Activas</b>
                        <span>@(Model != null ? Model.Count(c => c.ESTADO != null && c.ESTADO.NOMBRE == "Activo") : 0)</span>
                    </div>
                    <div class="stat">
                        <b>Inactivas</b>
                        <span>@(Model != null ? Model.Count(c => c.ESTADO == null || c.ESTADO.NOMBRE != "Activo") : 0)</span>
                    </div>
                    <div class="stat">
                        <b>Última acción</b>
                        <span>—</span>
                    </div>
                </div>
                <div class="hero__hint">
                    Asegurate de no eliminar categorías que estén en uso; podés desactivarlas si ya no se usan.
                </div>
            </div>
        </div }
    </div>
</section>

<section class="lp-section">
    <div class="lp-wrap">
        @if (TempData["OK"] != null) {
            <div class="alert alert-success">@TempData["OK"]</div>
        }
        @if (TempData["Mensaje"] != null) {
            <div class="alert alert-warning">@TempData["Mensaje"]</div>
        }

        <div class="panel">
            <div class="panel__head">
                <b>Listado de categorías</b>
                <span class="muted">Administrá los registros</span>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.ID_CATEGORIA</td>
                        <td>@item.NOMBRE</td>
                        <td>@item.DESCRIPCION</td>
                        <td>@item.ESTADO?.NOMBRE</td>
                        <td>
                            @if (rol == "ADMINISTRADOR")
                            {
                                @Html.ActionLink("Editar", "Edit", new { id = item.ID_CATEGORIA }, new { @class = "btn btn-sm btn-secondary" })

                                <form action='@Url.Action("Deactivate","Categorias")' method="post" style="display:inline;" class="confirm-deactivate">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.ID_CATEGORIA" />
                                    <button type="submit" class="btn btn-sm btn-danger">Desactivar</button>
                                </form>
                            }
                            else
                            {
                                <span class="muted">Sin permisos</span>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</section>

<footer class="lp-footer">
    <div class="lp-wrap footer">
        <div>© @DateTime.Now.Year AlphaStock</div>
        <div class="lp-muted">info@alphastock.com · +506 8888-8888</div>
    </div>
</footer>

@section scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var forms = document.querySelectorAll('form.confirm-deactivate');
            forms.forEach(function(f) {
                f.addEventListener('submit', function(e) {
                    var ok = confirm('¿Confirma desactivar esta categoría? Esta acción la pondrá como Inactiva.');
                    if (!ok) {
                        e.preventDefault();
                        return false;
                    }
                    // evitar doble envío
                    var btn = f.querySelector('button[type="submit"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerText = 'Procesando...';
                    }
                });
            });
        });
    </script>
}
