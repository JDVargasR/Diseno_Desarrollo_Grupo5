@model System.Collections.Generic.List<Proyecto_Diseno_Desarrollo_Grupo5.EF.ROLES>

@{
    ViewBag.Title = "Manejo de Roles";
    Layout = "~/Views/Shared/_LayoutCliente.cshtml";

    var q = (ViewBag.Q ?? "").ToString();
    var estado = (int)(ViewBag.Estado ?? 0);
}

@section styles{
    <link rel="stylesheet" href="~/StaticFiles/css/Roles.css" />
}

<main class="roles-page">
    <div class="container py-4">

        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
                <h2 class="mb-0">Manejo de Roles</h2>
            </div>

            <button id="btnNuevoRol" class="btn btn-primary btn-icon" type="button">
                <i class="bi bi-plus-lg me-1"></i> Nuevo Rol
            </button>
        </div>

        <!-- FILTROS -->
        <form id="frmFiltroRoles"
              method="get"
              action="@Url.Action("Index","Roles")"
              class="card roles-card mb-3">

            <div class="card-header">
                <div class="row g-2 align-items-end">

                    <!-- Buscar -->
                    <div class="col-12 col-md-6">
                        <label class="form-label mb-1">Buscar</label>
                        <input id="txtBuscar"
                               name="q"
                               value="@q"
                               type="text"
                               class="form-control"
                               placeholder="Buscar por nombre o descripción..." />
                    </div>

                    <!-- Estado -->
                    <div class="col-12 col-md-3">
                        <label class="form-label mb-1">Estado</label>
                        <select id="selEstado"
                                name="estado"
                                class="form-select">
                            <option value="0" @(estado == 0 ? "selected" : "")>Todos</option>
                            <option value="1" @(estado == 1 ? "selected" : "")>Activo</option>
                            <option value="2" @(estado == 2 ? "selected" : "")>Inactivo</option>
                        </select>
                    </div>

                    <!-- Limpiar -->
                    <div class="col-12 col-md-3 d-grid">
                        <a class="btn btn-outline-light text-dark btn-icon"
                           href="@Url.Action("Index","Roles")">
                            <i class="bi bi-arrow-clockwise me-1"></i> Limpiar
                        </a>
                    </div>

                </div>
            </div>
        </form>

        <!-- TABLA -->
        <div class="card roles-card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle roles-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width:90px;">ID</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th style="width:140px;">Estado</th>
                                <th style="width:220px;" class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model == null || Model.Count == 0)
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        No hay roles para mostrar.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                foreach (var r in Model)
                                {
                                    var esInactivo = (r.ID_ESTADO == 2);

                                    <tr>
                                        <td>@r.ID_ROL</td>
                                        <td><strong>@r.NOMBRE</strong></td>
                                        <td class="text-muted">@r.DESCRIPCION</td>
                                        <td>
                                            @if (r.ID_ESTADO == 1)
                                            {
                                                <span class="badge bg-success badge-estado">ACTIVO</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary badge-estado">INACTIVO</span>
                                            }
                                        </td>
                                        <td class="text-end">

                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary btn-icon me-1"
                                                    data-action="edit"
                                                    data-id="@r.ID_ROL"
                                                    data-nombre="@r.NOMBRE"
                                                    data-descripcion="@r.DESCRIPCION"
                                                    data-estado="@r.ID_ESTADO">
                                                <i class="bi bi-pencil-square me-1"></i> Editar
                                            </button>

                                            @using (Html.BeginForm("Deactivate", "Roles", FormMethod.Post, new { id = "frmDel_" + r.ID_ROL, style = "display:none;" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@r.ID_ROL" />
                                            }

                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger btn-icon"
                                                    data-action="deactivate"
                                                    data-form="frmDel_@r.ID_ROL"
                                                    data-nombre="@r.NOMBRE"
                                                    @(esInactivo ? "disabled" : "")>
                                                <i class="bi bi-slash-circle me-1"></i> Inactivar
                                            </button>

                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">Total: @(Model?.Count ?? 0)</small>
                <small class="text-muted">AlphaStock</small>
            </div>
        </div>

        <!-- Mensajes para SweetAlert -->
        <div id="swalMsg"
             data-ok="@(ViewBag.OK ?? "")"
             data-error="@(ViewBag.Mensaje ?? "")"
             style="display:none;"></div>

    </div>
</main>

<!-- MODAL (Crear/Editar) -->
<div class="modal fade" id="modalRol" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Rol</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                @using (Html.BeginForm("Create", "Roles", FormMethod.Post, new
                {
                    id = "formRol",
                    data_create_url = Url.Action("Create", "Roles"),
                    data_update_url = Url.Action("Update", "Roles")
                }))
                {
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="rolId" name="IdRol" value="0" />

                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input id="rolNombre" name="Nombre" type="text" class="form-control" maxlength="60" placeholder="Ej: ADMINISTRADOR" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea id="rolDescripcion" name="Descripcion" class="form-control" rows="3" maxlength="200"
                                  placeholder="Describe el rol..."></textarea>
                    </div>

                    <div class="mb-0">
                        <label class="form-label">Estado</label>
                        <select id="rolEstado" name="IdEstado" class="form-select">
                            <option value="1">ACTIVO</option>
                            <option value="2">INACTIVO</option>
                        </select>
                        <div class="form-text">“Eliminar” cambiará el estado a INACTIVO.</div>
                    </div>

                    <div class="mt-3 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary btn-icon">
                            <i class="bi bi-save2 me-1"></i> Guardar
                        </button>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/StaticFiles/js/Roles.js"></script>
}
